<!DOCTYPE html>
<html>
  <head>
    <style>
      #scream {
        /* width: 30%; */
      }

      #code_preview {
        height: 200px;
        width: 500px;
      }
    </style>
  </head>
  <body>

    <img id="scream" src="/static/images/new_image51.png.png" alt="The Scream">

    <canvas id="myCanvas">
      Your browser does not support the HTML5 canvas tag.
    </canvas>
    <br />
      <textarea id="code_preview">
var algo =  function(imgData) {  
    // invert colors
    for (var i=0;i<imgData.data.length;i+=4)
    {
        var THRESHOLD = 150;

        imgData.data[i] = 255 - imgData.data[i] % 255;
        imgData.data[i+1] = 255 - imgData.data[i+1] % 255;
        imgData.data[i+2] = 255 - imgData.data[i+2] % 255;
        var pixel_color_is_gray = (130 < imgData.data[i] && imgData.data[i] < 200) && 
            (130 < imgData.data[i+1] && imgData.data[i+1] < 200) && 
            (130 < imgData.data[i+2] && imgData.data[i+2] < 200); 

        if (pixel_color_is_gray) { 
            imgData.data[i] = 255;
            imgData.data[i+1] = 255;
            imgData.data[i+2] = 255;

        }
        imgData.data[i+3] = 255;
    }

    return imgData;
}

run_algo(algo);
      </textarea>

      <input type="submit" onclick="submit()" />

    <script>
      var img;

      Element.prototype.remove = function() {
        this.parentElement.removeChild(this);
      }
      NodeList.prototype.remove = HTMLCollection.prototype.remove = function() {
        for(var i = 0, len = this.length; i < len; i++) {
          if(this[i] && this[i].parentElement) {
            this[i].parentElement.removeChild(this[i]);
          }
        }
      }

      var submit = function() {
        var code_preview = document.getElementById('code_preview');
        var algo_code = code_preview.value;

        var code_runner = document.getElementById('code_runner'); 

        if (code_runner) {
          code_runner.remove();
        }

        code_runner = document.createElement('script');
        code_runner.id = 'code_runner';
        var code = document.createTextNode(algo_code);
        code_runner.appendChild(code);

        document.body.insertBefore(code_runner, code_preview);
      }

      var run_algo = function(algo_fn) {
        img = document.getElementById("scream");

        var c = document.getElementById("myCanvas");
        c.width = img.width;
        c.height = img.height;

        var ctx = c.getContext("2d");
        ctx.drawImage(img, 0, 0, img.width, img.height);

        var imgData = ctx.getImageData(0, 0, img.width, img.height);

        imgData = algo_fn(imgData);

        ctx.putImageData(imgData,0,0);
      };

    </script>

  </body>
</html>

